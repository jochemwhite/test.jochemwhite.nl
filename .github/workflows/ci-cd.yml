name: Update Package.json Version and Build/Push Docker Image

on:
  push:
    branches:
      - main

jobs:
  update-and-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Login to GitHub Container Registry
        run: echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Update Package.json Version
        run: |
          # Get the current version from package.json
          CURRENT_VERSION=$(node -p "require('./package.json').version")

          # Calculate the new version (e.g., increment the patch version)
          NEW_VERSION=$(npm --no-git-tag-version version patch)

          # Update package.json with the new version
          npm --no-git-tag-version version $NEW_VERSION
          echo "Updated package.json version to $NEW_VERSION"

          # Check if there are changes to commit
          if git diff --quiet; then
            echo "No changes to commit."
          else
            # Commit the updated package.json and package-lock.json (if updated)
            git config user.email "actions@github.com"
            git config user.name "GitHub Actions"
            git add package.json
            git commit -m "Bump version to $NEW_VERSION"
            git push
          fi

      - name: Build and push Docker image to GHCR
        run: |
          echo "Building and pushing Docker image to GHCR... to tag $NEW_VERSION"

          DOCKER_TAG="ghcr.io/${{ github.repository }}:$NEW_VERSION"
          docker build -t $DOCKER_TAG .
          docker push $DOCKER_TAG
